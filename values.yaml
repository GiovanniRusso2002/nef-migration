# Global helpers and defaults
# todo: set name as services (to avoid misunderstadings)

global:
  imagePullSecrets: []
  imagePullPolicy: IfNotPresent
  # Default security contexts applied to all services
  defaultPodSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  defaultSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  defaultResources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

asSessionWithQos:
  enabled: true
  image: "openexposure/as-session-with-qos:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTP_PORT
    value: "8080"
  config:
    enabled: true
    data:
      nbi:
        httpVersion: 1
        useTLS: false
        fqdn: "3gpp-as-session-with-qos.local"
        port: 8080
      sbi:
        nrfSvc: "http://nrf.net01.3gpp.eurecom.fr"
        useNrf: false
        pcfSvc: "http://core-simulator:8080"
        httpVersion: 2
      supportedFeatures: "3fff"
      capifSvc: capif-connector:8080
    qosConfig:
      qos-e:
        marBwDl: 120000
        marBwUl: 120000
        mediaType: CONTROL
      qos2:
        marBwDl: 240000
        marBwUl: 240000
        mediaType: CONTROL
      qos3:
        marBwDl: 480000
        marBwUl: 480000
        mediaType: CONTROL
      qos4:
        marBwDl: 960000
        marBwUl: 960000
        mediaType: VIDEO

trafficInfluence:
  enabled: true
  image: "openexposure/traffic-influence:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTP_PORT
    value: "8080"
  config:
    enabled: true
    data:
      nbi:
        httpVersion: 1
        useTLS: false
        fqdn: "3gpp-traffic-influence.local"
        port: 8080
      sbi:
        nrfSvc: http://nrf.net01.3gpp.eurecom.fr
        useNrf: false
        pcfSvc: http://nef-core-simulator:8080
        httpVersion: 2

      supportedFeatures: "3fff"
      capifSvc: nef-capif:8080

monitoringEvent:
  enabled: true
  image: "openexposure/monitoring-event:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTP_PORT
    value: "8080"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  - name: REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: nef-redis-secret
        key: redis-password
  config:
    enabled: true
    data:
      nbi:
        httpVersion: 1
        useTLS: false
        fqdn: "3gpp-monitoing-event.local"
        port: 8080
      sbi:
        identitySvc: "http://nef-ue-identity:8080"
        redisSvc: "redis://redis-stack:6379/"
        httpVersion: 2
      supportedFeatures: "3fff"
      capifSvc: nef-capif:8080

ueIdentity:
  enabled: true
  image: "openexposure/ue-identity-service:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTP_PORT
    value: "8080"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  - name: NBI_PORT
    value: "8080"
  - name: HTTPS
    value: "false"
  - name: HTTP_VER
    value: "1"

datasetExporter:
  enabled: true
  image: "openexposure/dataset-exporter:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTP_PORT
    value: "8080"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  - name: HTTPS
    value: "false"
  - name: HTTP_VER
    value: "1"

ueProfile:
  enabled: true
  image: "openexposure/ue-profile-service:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: HTTPS
    value: false
  - name: CN_HTTP_VERSION
    value: "1"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  - name: NBI_PORT
    value: "8080"

ueAddress:
  enabled: true
  image: "openexposure/ue-address:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  config:
    enabled: true
    data:
      nbi:
        httpVersion: 1
        useTLS: false
        fqdn: 3gpp-ue-address.local
        port: 8080
      sbi:
        identitySvc: http://identity-service:8080
        profileSvc: http://ue-profile-service:8080
        httpVersion: 1
      supportedFeatures: 3fff
      capifSvc: nef-capif:8080

ueId:
  enabled: true
  image: "openexposure/ue-id:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  config:
    enabled: true
    data:
      nbi:
        httpVersion: 1
        useTLS: false
        fqdn: 3gpp-ueid.local
        port: 8080
      sbi:
        identitySvc: http://identity-service:8080
        httpVersion: 1
      supportedFeatures: 3fff
      capifSvc: nef-capif:8080

coreNetwork:
  enabled: true
  image: "openexposure/core-network-service:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 150m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  replicaCount: 1
  type: ClusterIP
  port: 9090
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  env:
  - name: USE_NRF
    value: "false"
  - name: CN_HTTP_VERSION
    value: "1"
  - name: REDIS_ADDR
    value: "redis-stack:6379"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  - name: AMF_IP_ADDR
    value: "http://nef-core-simulator:8080"
  - name: AMF_SUBSCR_ROUTE
    value: "/namf-evts/v1"
  - name: AMF_API_ROUTE
    value: "/test/amf"
  - name: AMF_NOTIFY_CORRELATION_ID
    value: "string"
  - name: AMF_NOTIFICATION_ID
    value: "1"
  - name: AMF_NOTIFICATION_FORWARD_ROUTE
    value: "/sbi/notification/amf"
  - name: SMF_IP_ADDR
    value: "http://nef-core-simulator:8080"
  - name: SMF_SUBSCR_ROUTE
    value: "/nsmf_event-exposure/v1"
  - name: SMF_API_ROUTE
    value: "/test/smf"
  - name: SMF_NOTIFY_CORRELATION_ID
    value: "string"
  - name: SMF_NOTIFICATION_ID
    value: "2"
  - name: SMF_NOTIFICATION_FORWARD_ROUTE
    value: "/sbi/notification/smf"
  - name: EVENT_NOTIFY_URI
    value: "http://nef-core-network:9090"
  - name: SERVER_ADDR
    value: "0.0.0.0:9090" # bind to all interfaces, not to the service ClusterIP nef-core-network:9090
    # value: "nef-core-network:9090" Application binds to all available interfaces on the Pod
    # Traffic flow: Client → Service (10.96.252.195:9090) → kube-proxy routes → Pod (10.244.0.5:9090) → Your app listening on 0.0.0.0:9090
    # The Service acts as a router/load balancer, not a binding address
    # Your Service nef-core-network has a ClusterIP (10.96.252.195)
    # This IP doesn't exist on any Pod - it's a virtual IP managed by kube-proxy
    # kube-proxy uses iptables/ipvs rules to route traffic from this ClusterIP to the actual Pod IPs

coreSimulator:
  enabled: true
  image: "openexposure/core-simulator:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  extraPorts:
  - port: 8081
    name: oam
  - port: 9090
    name: metrics
  prometheusPort: 9090
  env:
  - name: REDIS_ADDR
    value: "redis-stack:6379"
  - name: REDIS_SVC
    value: "redis-stack:6379"
  config:
    enabled: true
    data:
      httpVersion: 2
      fqdn: core-simulator
      sbiPort: 8080
      oamPort: 8081
      initOnStartup: true
      simulationProfile:
        plmn:
          mcc: "001"
          mnc: "01"
        dnn: "internet"
        slice:
          sst: 1
          sd: "FFFFFF"
        numOfUe: 20
        numOfgNB: 10
        arrivalRate: 2

capif:
  enabled: true
  image: "openexposure/capif-service:develop"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 8080
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  auth:
    username: "nef-semproj"
    password: "" # Set via secret: nef-capif-secret
  env:
  - name: CAPIF_FQDN
    value: "vm03.netsoft.cs.eurecom.fr"
  - name: CAPIF_AUTH_PORT
    value: "8084"
  - name: CAPIF_USERNAME
    valueFrom:
      secretKeyRef:
        name: nef-capif-secret
        key: capif-username
  - name: CAPIF_PASSWORD
    valueFrom:
      secretKeyRef:
        name: nef-capif-secret
        key: capif-password
  - name: INGRESS_FQDN
    value: ""

prometheus:
  enabled: true
  image: "prom/prometheus:latest"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi
  replicaCount: 1
  port: 9090
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534 # nobody user for prometheus
    runAsGroup: 65534
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  config:
    enabled: true
    data:
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      scrape_configs:
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_scrape ]
          action: keep
          regex: true
        - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_path ]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [ __address__, __meta_kubernetes_pod_annotation_prometheus_io_port ]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__

grafana:
  enabled: true
  image: "grafana/grafana:latest"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi
  replicaCount: 1
  port: 3000
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 472 # grafana user
    runAsGroup: 472
    fsGroup: 472
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL
  auth:
    adminUser: "admin"
    adminPassword: "" # Set via secret: nef-grafana-secret
  env:
  - name: GF_SECURITY_ADMIN_USER
    valueFrom:
      secretKeyRef:
        name: nef-grafana-secret
        key: admin-user
  - name: GF_SECURITY_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: nef-grafana-secret
        key: admin-password
  - name: GF_AUTH_ANONYMOUS_ENABLED
    value: "false"
  - name: GF_SECURITY_DISABLE_GRAVATAR
    value: "true"
  - name: GF_ANALYTICS_REPORTING_ENABLED
    value: "false"
  - name: GF_ANALYTICS_CHECK_FOR_UPDATES
    value: "false"
  - name: GF_SERVER_ROOT_URL
    value: "%(protocol)s://%(domain)s:%(http_port)s/grafana/"
  - name: GF_SERVER_SERVE_FROM_SUB_PATH
    value: "true"
  config:
    enabled: true
    datasources:
      apiVersion: 1
      datasources:
      - name: prometheus
        type: prometheus
        access: proxy
        url: http://nef-prometheus:9090
        isDefault: true
        editable: false # todo determine if true or false (ask Giulio as there are two conflicting requirements)
    dashboards:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards

redis:
  enabled: true

  redis:
    image:
      repository: redis/redis-stack-server
      tag: latest

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  auth:
    enabled: false
    password: "" # Set via secret: nef-redis-secret

redisInsight:
  enabled: true
  image: "redis/redisinsight:latest"
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  replicaCount: 1
  port: 5540
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000 # Redis Insight official image uses UID 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false # RedisInsight needs to write logs and data
    runAsNonRoot: true
    capabilities:
      drop:
      - ALL

ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    # TLS and HTTPS enforcement
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'";
    # TLS configuration
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305"
    nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers: "true"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
  hosts:
  - host: nef.local
    paths:
    - path: /3gpp-as-session-with-qos
      pathType: Prefix
      service: nef-as-session-with-qos
      port: 8080
    - path: /3gpp-traffic-influence
      pathType: Prefix
      service: nef-traffic-influence
      port: 8080
    - path: /3gpp-monitoring-event
      pathType: Prefix
      service: nef-monitoring-event
      port: 8080
    - path: /3gpp-ue-id
      pathType: Prefix
      service: nef-ue-id
      port: 8080
    - path: /3gpp-ue-address
      pathType: Prefix
      service: nef-ue-address
      port: 8080
    - path: /grafana
      pathType: Prefix
      service: nef-grafana
      port: 3000
    - path: /prometheus
      pathType: Prefix
      service: nef-prometheus
      port: 9090
  tls:
  - secretName: nef-tls-cert
    hosts:
    - nef.local

# Network Policies for network segmentation and security
networkPolicy:
  enabled: true

# Pod Disruption Budgets for high availability
podDisruptionBudget:
  enabled: true
  monitoringEvent:
    minAvailable: 1
  ueIdentity:
    minAvailable: 1
  coreSimulator:
    minAvailable: 1
  redis:
    minAvailable: 1
  prometheus:
    minAvailable: 1
  grafana:
    minAvailable: 1
